{# templates/grids.html #}
{# 网格管理页面 - 最终版：保持当前布局 + 编辑按钮跳转到独立编辑页 edit_grid.html + 移除无效 JS #}

{% extends "base.html" %}
{% block title %}网格管理{% endblock %}

{% include 'includes/_list_management.html' %}

{% block content %}
<div class="content-wrapper">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h5 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-grid-3x3-gap me-2"></i>网格管理
                    </h5>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addModal">
                        <i class="bi bi-plus-lg me-1"></i>新增网格
                    </button>
                </div>

                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show mb-3" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <div class="table-responsive">
                        <table class="table table-hover table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th width="5%">#</th>
                                    <th width="20%">网格名称</th>
                                    <th width="35%">负责人</th>
                                    <th width="10%">状态</th>
                                    <th width="30%" class="text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if grids %}
                                    {% for g in grids %}
                                    {% set is_virtual = g.name.startswith('虚拟网格') %}
                                    {% set is_disabled = g.is_deleted == 1 %}
                                    <tr {% if is_disabled %}class="table-secondary"{% endif %}>
                                        <td>{{ loop.index }}</td>
                                        <td>
                                            <strong>{{ g.name }}</strong>
                                            {% if is_disabled %}
                                                <small class="text-muted ms-2">(已禁用)</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if g.managers %}
                                                {{ g.managers.replace(',', '、') }}
                                            {% elif is_virtual %}
                                                <em class="text-muted">系统内置</em>
                                            {% else %}
                                                <em class="text-muted">无</em>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if is_disabled %}
                                                <span class="badge bg-danger">已禁用</span>
                                            {% else %}
                                                <span class="badge bg-success">正常</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if not is_virtual and not is_disabled %}
                                                <!-- 改为直接链接跳转到独立编辑页 -->
                                                <a href="{{ url_for('grid.edit', grid_id=g.id) }}" class="btn btn-warning btn-sm me-1" title="编辑">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            {% endif %}

                                            {% if not is_virtual %}
                                                <form method="post" action="{{ url_for('grid.toggle_status', grid_id=g.id) }}" class="d-inline"
                                                      onsubmit="return confirm('确定{{ '启用' if is_disabled else '禁用' }}网格「{{ g.name }}」吗？');">
                                                    <button type="submit" class="btn btn-{{ 'success' if is_disabled else 'danger' }} btn-sm">
                                                        <i class="bi bi-{{ 'play-circle' if is_disabled else 'pause-circle' }}"></i>
                                                        {{ '启用' if is_disabled else '禁用' }}
                                                    </button>
                                                </form>
                                            {% else %}
                                                <span class="text-muted small">系统内置，不可操作</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                                            暂无网格记录，请点击右上角“新增网格”添加
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增模态框（保持不变） -->
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <form method="POST" action="{{ url_for('grid.add') }}">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">新增网格</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">网格名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" required maxlength="50">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-success">保存</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 已移除编辑模态框（editModal），因为现在使用独立页面 edit_grid.html -->
{% endblock %}

{# 已移除 extra_js 块，因为不再需要动态设置 action 和预加载 JS #}
