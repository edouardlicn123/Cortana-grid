{# templates/system_settings.html #}
{# 系统设置页完整最终版 - 2026-01-03（已删除网格分配 Tab） #}

{% extends "base.html" %}
{% block title %}系统设置{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="mb-5 text-center fw-bold text-primary">
        <i class="bi bi-tools me-3 fs-1"></i>
        系统设置面板
    </h2>

    <!-- Tabs 导航 - 已移除网格分配 Tab -->
    <ul class="nav nav-tabs mb-5 justify-content-center shadow rounded-4 bg-light p-2" id="settingsTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link px-5 py-3 rounded-4 {% if tab == 'general' or not tab %}active{% endif %}" 
                    id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                <i class="bi bi-gear-wide-connected me-2"></i>通用设置
            </button>
        </li>

        {% if current_user.has_permission('system:manage_permissions') or current_user.has_role('super_admin') %}
        <li class="nav-item" role="presentation">
            <button class="nav-link px-5 py-3 rounded-4 {% if tab == 'permissions' %}active{% endif %}" 
                    id="permissions-tab" data-bs-toggle="tab" data-bs-target="#permissions" type="button" role="tab">
                <i class="bi bi-shield-lock-fill me-2"></i>角色权限
            </button>
        </li>
        {% endif %}

        <li class="nav-item" role="presentation">
            <button class="nav-link px-5 py-3 rounded-4 {% if tab == 'users' %}active{% endif %}" 
                    id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                <i class="bi bi-people-fill me-2"></i>用户管理
            </button>
        </li>
    </ul>

    <div class="tab-content" id="settingsTabContent">
        <!-- 通用设置 -->
        <div class="tab-pane fade {% if tab == 'general' or not tab %}show active{% endif %}" id="general" role="tabpanel">
            <div class="row justify-content-center">
                <div class="col-lg-8 col-xl-7">
                    <div class="card shadow-lg border-0 rounded-4">
                        <div class="card-header bg-gradient bg-primary text-white text-center py-4 rounded-top-4">
                            <h4 class="mb-0"><i class="bi bi-globe-asia-australia me-2"></i>通用系统配置</h4>
                        </div>
                        <div class="card-body p-5">
                            <form method="POST">
                                <input type="hidden" name="action" value="update_general">

                                <div class="mb-4">
                                    <label for="community_name" class="form-label fw-bold fs-5">社区名称</label>
                                    <input type="text" name="community_name" id="community_name" 
                                           class="form-control form-control-lg rounded-pill" value="{{ community_name }}" required>
                                    <div class="form-text">显示在导航栏、标题和报告中</div>
                                </div>

                                <div class="mb-4">
                                    <label for="default_page_size" class="form-label fw-bold fs-5">默认分页大小</label>
                                    <select name="default_page_size" id="default_page_size" class="form-select form-select-lg rounded-pill">
                                        <option value="10" {% if default_page_size == '10' %}selected{% endif %}>10 条/页</option>
                                        <option value="20" {% if default_page_size == '20' %}selected{% endif %}>20 条/页</option>
                                        <option value="50" {% if default_page_size == '50' %}selected{% endif %}>50 条/页</option>
                                    </select>
                                    <div class="form-text">新用户默认每页显示条数（个人设置可覆盖）</div>
                                </div>

                                <div class="form-check form-switch mb-5">
                                    <input class="form-check-input" type="checkbox" id="show_default_credentials" name="show_default_credentials"
                                           {% if show_default_credentials %}checked{% endif %}>
                                    <label class="form-check-label fs-5 fw-bold" for="show_default_credentials">
                                        在登录页显示默认凭证提示
                                    </label>
                                    <div class="form-text text-muted">仅建议在开发/测试环境启用，生产环境请关闭</div>
                                </div>

                                <div class="text-center mt-5">
                                    <button type="submit" class="btn btn-primary btn-lg px-5 py-3 shadow rounded-pill">
                                        <i class="bi bi-save-fill me-2"></i>保存通用设置
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 角色权限管理 -->
        {% if current_user.has_permission('system:manage_permissions') or current_user.has_role('super_admin') %}
        <div class="tab-pane fade {% if tab == 'permissions' %}show active{% endif %}" id="permissions" role="tabpanel">
            <div class="row justify-content-center">
                <div class="col-lg-10 col-xl-9">
                    <div class="card shadow-lg border-0 rounded-4">
                        <div class="card-header bg-gradient bg-primary text-white text-center py-4 rounded-top-4">
                            <h4 class="mb-0"><i class="bi bi-key-fill me-2"></i>角色权限编辑</h4>
                        </div>
                        <div class="card-body p-5">
                            <div class="text-center mb-5">
                                <label for="roleSelect" class="form-label fw-bold fs-4 mb-3">选择角色</label>
                                <select class="form-select form-select-lg w-auto d-inline-block rounded-pill" id="roleSelect">
                                    <option value="">-- 请选择角色 --</option>
                                    {% if roles %}
                                        {% for role in roles %}
                                        <option value="{{ role.id }}" {% if selected_role_id == role.id %}selected{% endif %}>
                                            {{ role.name | replace('community_admin', '社区管理员') | replace('grid_user', '网格员') | title }}
                                        </option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="" disabled>无可用角色（请检查数据库）</option>
                                    {% endif %}
                                </select>

                                {% if not roles %}
                                <div class="alert alert-warning mt-3">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    未检测到可编辑角色（社区管理员 / 网格员）。请刷新页面或检查数据库初始化。
                                </div>
                                {% endif %}
                            </div>

                            <script>
                                document.getElementById('roleSelect').addEventListener('change', function() {
                                    const roleId = this.value;
                                    if (roleId) {
                                        window.location.href = '{{ url_for("system_settings.index") }}?tab=permissions&role_id=' + roleId;
                                    } else {
                                        window.location.href = '{{ url_for("system_settings.index") }}?tab=permissions';
                                    }
                                });
                            </script>

                            {% if selected_role_id %}
                            <form method="POST">
                                <input type="hidden" name="action" value="update_permissions">
                                <input type="hidden" name="role_id" value="{{ selected_role_id }}">
                                <input type="hidden" name="tab" value="permissions">

                                <h4 class="text-center mb-5 text-primary fw-bold">
                                    编辑角色：{{ selected_role_name | replace('community_admin', '社区管理员') | replace('grid_user', '网格员') | title }}
                                </h4>

                                <div class="row g-4 justify-content-center mb-5">
                                    {% for resource, actions in {
                                        '人员管理': ['view', 'add', 'edit', 'delete'],
                                        '小区/建筑': ['view', 'add', 'edit', 'delete'],
                                        '网格管理': ['view', 'add', 'edit', 'delete']
                                    }.items() %}
                                    {% set resource_index = loop.index %}
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card h-100 border-primary shadow-sm hover-shadow rounded-3">
                                            <div class="card-header bg-primary text-white text-center py-3 rounded-top-3">
                                                <h6 class="mb-0 fw-bold">{{ resource }}</h6>
                                            </div>
                                            <div class="card-body p-4">
                                                {% for action in actions %}
                                                {% set perm = 'resource:' ~ resource|lower|replace('/', '_') ~ ':' ~ action %}
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="permissions" value="{{ perm }}"
                                                           id="perm_{{ resource_index }}_{{ loop.index }}"
                                                           {% if perm in current_role_permissions %}checked{% endif %}>
                                                    <label class="form-check-label fw-medium" for="perm_{{ resource_index }}_{{ loop.index }}">
                                                        {% if action == 'view' %}查看
                                                        {% elif action == 'add' %}新增
                                                        {% elif action == 'edit' %}修改
                                                        {% elif action == 'delete' %}删除{% endif %}
                                                    </label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                <div class="row justify-content-center">
                                    <div class="col-md-8 col-lg-6">
                                        <div class="card border-success shadow-sm hover-shadow rounded-3">
                                            <div class="card-header bg-success text-white text-center py-3 rounded-top-3">
                                                <h6 class="mb-0 fw-bold">全局权限</h6>
                                            </div>
                                            <div class="card-body p-4">
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="permissions" value="import_export:all"
                                                           id="perm_import_export" {% if 'import_export:all' in current_role_permissions %}checked{% endif %}>
                                                    <label class="form-check-label fw-medium" for="perm_import_export">导入导出全部数据</label>
                                                </div>
                                                <div class="form-check mb-3">
                                                    <input class="form-check-input" type="checkbox" name="permissions" value="system:view"
                                                           id="perm_system_view" {% if 'system:view' in current_role_permissions %}checked{% endif %}>
                                                    <label class="form-check-label fw-medium" for="perm_system_view">访问系统设置页面</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="text-center mt-5">
                                    <button type="submit" class="btn btn-primary btn-lg px-5 py-3 shadow rounded-pill">
                                        <i class="bi bi-save-fill me-2"></i>保存权限
                                    </button>
                                    <button type="button" id="restoreDefaultBtn" class="btn btn-warning btn-lg px-5 py-3 ms-3 shadow rounded-pill">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>恢复默认
                                    </button>
                                </div>
                            </form>
                            {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-info-circle-fill fs-1"></i>
                                <p class="mt-3 fs-4">请选择一个角色开始编辑权限</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 用户管理 -->
        <div class="tab-pane fade {% if tab == 'users' %}show active{% endif %}" id="users" role="tabpanel">
            <div class="row justify-content-center">
                <div class="col-lg-10 col-xl-9">
                    <div class="card shadow-lg border-0 rounded-4">
                        <div class="card-header bg-gradient bg-primary text-white text-center py-4 rounded-top-4">
                            <h4 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>用户管理</h4>
                        </div>
                        <div class="card-body p-5">
                            <div class="text-end mb-4">
                                <button class="btn btn-success btn-lg px-5 rounded-pill shadow" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                    <i class="bi bi-person-plus-fill me-2"></i>添加新用户
                                </button>
                            </div>

                            <div class="mb-4">
                                <input type="text" id="userSearch" class="form-control form-control-lg rounded-pill" placeholder="搜索用户名或姓名...">
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover align-middle" id="userTable">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>用户名</th>
                                            <th>显示姓名</th>
                                            <th>电话</th>
                                            <th>角色</th>
                                            <th>状态</th>
                                            <th class="text-center">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user in users %}
                                        <tr>
                                            <td><strong>{{ user.username }}</strong></td>
                                            <td>{{ user.full_name or '-' }}</td>
                                            <td>{{ user.phone or '-' }}</td>
                                            <td>
                                                {% if user.roles %}
                                                    {% for role in user.roles %}
                                                    <span class="badge bg-info me-1">{{ role | replace('community_admin', '社区管理员') | replace('grid_user', '网格员') }}</span>
                                                    {% endfor %}
                                                {% else %}
                                                    <span class="text-muted">无角色</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if user.is_active %}
                                                    <span class="badge bg-success">启用</span>
                                                {% else %}
                                                    <span class="badge bg-danger">禁用</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <form method="POST" action="{{ url_for('system_settings.toggle_user', user_id=user.id) }}" class="d-inline">
                                                    <button type="submit" class="btn btn-sm btn-outline-primary rounded-pill">
                                                        {% if user.is_active %}禁用{% else %}启用{% endif %}
                                                    </button>
                                                </form>
                                                <form method="POST" action="{{ url_for('system_settings.reset_password', user_id=user.id) }}" class="d-inline ms-2" onsubmit="return confirm('确定重置密码？')">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill">重置密码</button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加新用户模态框 -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-4 shadow-lg">
            <form method="POST" action="{{ url_for('system_settings.add_user') }}">
                <div class="modal-header bg-primary text-white rounded-top-4 py-4">
                    <h5 class="modal-title" id="addUserLabel"><i class="bi bi-person-add me-2"></i>添加新用户</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body p-5">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label for="new_username" class="form-label fw-bold">用户名 <span class="text-danger">*</span></label>
                            <input type="text" name="username" id="new_username" class="form-control form-control-lg rounded-pill" required>
                        </div>
                        <div class="col-md-6">
                            <label for="new_full_name" class="form-label fw-bold">显示姓名</label>
                            <input type="text" name="full_name" id="new_full_name" class="form-control form-control-lg rounded-pill">
                        </div>
                        <div class="col-md-6">
                            <label for="new_phone" class="form-label fw-bold">电话</label>
                            <input type="tel" name="phone" id="new_phone" class="form-control form-control-lg rounded-pill">
                        </div>
                        <div class="col-md-6">
                            <label for="new_role" class="form-label fw-bold">分配角色 <span class="text-danger">*</span></label>
                            <select name="role_id" id="new_role" class="form-select form-select-lg rounded-pill" required>
                                <option value="">-- 选择角色 --</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}">{{ role.name | replace('community_admin', '社区管理员') | replace('grid_user', '网格员') | title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0 pb-5 px-5 justify-content-center">
                    <button type="button" class="btn btn-secondary btn-lg px-5 rounded-pill" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary btn-lg px-5 rounded-pill shadow">添加用户</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .hover-shadow:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15) !important;
        transition: all 0.25s ease;
    }
    .nav-tabs .nav-link {
        border: none;
        font-weight: 700;
        color: var(--bs-primary);
    }
    .nav-tabs .nav-link.active {
        background: var(--bs-primary) !important;
        color: white !important;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .card-header.bg-gradient {
        background: linear-gradient(135deg, var(--bs-primary) 0%, var(--bs-primary-dark) 100%) !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // 用户搜索（用户管理 Tab）
    const userSearch = document.getElementById('userSearch');
    const userTable = document.getElementById('userTable');
    if (userSearch && userTable) {
        userSearch.addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            userTable.querySelectorAll('tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    }

    // 恢复默认权限（角色权限 Tab）
    const restoreBtn = document.getElementById('restoreDefaultBtn');
    if (restoreBtn) {
        restoreBtn.addEventListener('click', function() {
            if (confirm('确认恢复该角色的默认权限？此操作不可撤销。')) {
                const form = this.closest('form');
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'restore_default';
                input.value = 'true';
                form.appendChild(input);
                form.submit();
            }
        });
    }
</script>
{% endblock %}
