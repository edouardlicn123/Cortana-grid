{# templates/system_settings.html #}
{# 系统设置页 - 用户管理操作按钮优化：保持 btn-sm 大小，优化间距，避免拥挤换行 #}

{% extends "base.html" %}
{% block title %}系统设置{% endblock %}

<!-- 插入通用列表界面css -->
{% include 'includes/_list_management.html' %}

{% block content %}
<div class="content-wrapper">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h5 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-tools me-2"></i>系统设置面板
                    </h5>
                </div>

                <div class="card-body">

                    <!-- Tabs 导航 -->
                    <ul class="nav nav-tabs mb-4" id="settingsTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if tab == 'general' or not tab %}active{% endif %}" 
                                    id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                                <i class="bi bi-gear-wide-connected me-2"></i>通用设置
                            </button>
                        </li>

                        {% if current_user.has_permission('system:manage_permissions') or current_user.has_role('super_admin') %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if tab == 'permissions' %}active{% endif %}" 
                                    id="permissions-tab" data-bs-toggle="tab" data-bs-target="#permissions" type="button" role="tab">
                                <i class="bi bi-shield-lock-fill me-2"></i>角色权限
                            </button>
                        </li>
                        {% endif %}

                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if tab == 'users' %}active{% endif %}" 
                                    id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                                <i class="bi bi-people-fill me-2"></i>用户管理
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="settingsTabContent">
                        <!-- 通用设置（保持不变） -->
                        <div class="tab-pane fade {% if tab == 'general' or not tab %}show active{% endif %}" id="general" role="tabpanel">
                            <form method="POST">
                                <input type="hidden" name="action" value="update_general">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">社区名称</label>
                                        <input type="text" name="community_name" class="form-control form-control-lg" 
                                               value="{{ community_name }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">默认分页大小</label>
                                        <select name="default_page_size" class="form-select form-select-lg">
                                            <option value="10" {% if default_page_size == '10' %}selected{% endif %}>10 条/页</option>
                                            <option value="20" {% if default_page_size == '20' %}selected{% endif %}>20 条/页</option>
                                            <option value="50" {% if default_page_size == '50' %}selected{% endif %}>50 条/页</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="show_default_credentials" 
                                                   name="show_default_credentials" {% if show_default_credentials %}checked{% endif %}>
                                            <label class="form-check-label" for="show_default_credentials">
                                                在登录页显示默认凭证提示（仅建议开发/测试环境启用）
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg px-5">
                                        <i class="bi bi-save me-2"></i>保存通用设置
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- 角色权限管理（保持不变） -->
                        {% if current_user.has_permission('system:manage_permissions') or current_user.has_role('super_admin') %}
                        <div class="tab-pane fade {% if tab == 'permissions' %}show active{% endif %}" id="permissions" role="tabpanel">
                            <div class="text-center mb-4">
                                <label class="form-label fw-bold">选择角色</label>
                                <select class="form-select form-select-lg w-auto d-inline-block" id="roleSelect">
                                    <option value="">-- 请选择角色 --</option>
                                    {% for role in roles %}
                                    <option value="{{ role.id }}" {% if selected_role_id == role.id %}selected{% endif %}>
                                        {{ role.name | replace('community_admin', '社区管理员') | replace('grid_user', '网格员') | title }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <script>
                                document.getElementById('roleSelect').addEventListener('change', function() {
                                    const roleId = this.value;
                                    if (roleId) {
                                        window.location.href = '{{ url_for("system_settings.index") }}?tab=permissions&role_id=' + roleId;
                                    } else {
                                        window.location.href = '{{ url_for("system_settings.index") }}?tab=permissions';
                                    }
                                });
                            </script>

                            {% if selected_role_id %}
                            <form method="POST">
                                <input type="hidden" name="action" value="update_permissions">
                                <input type="hidden" name="role_id" value="{{ selected_role_id }}">

                                <h5 class="text-center mb-4 text-primary fw-bold">
                                    当前编辑角色：{{ selected_role_name | replace('community_admin', '社区管理员') | replace('grid_user', '网格员') | title }}
                                </h5>

                                <div class="table-responsive">
                                    <table class="table table-hover table-bordered align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="40%">权限分类</th>
                                                <th width="15%" class="text-center">查看</th>
                                                <th width="15%" class="text-center">新增</th>
                                                <th width="15%" class="text-center">编辑</th>
                                                <th width="15%" class="text-center">删除</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong>人员管理</strong></td>
                                                <td class="text-center"><input type="checkbox" name="permissions" value="resource:person:view" {% if 'resource:person:view' in current_role_permissions %}checked{% endif %}></td>
                                                <td class="text-center"><input type="checkbox" name="permissions" value="resource:person:add" {% if 'resource:person:add' in current_role_permissions %}checked{% endif %}></td>
                                                <td class="text-center"><input type="checkbox" name="permissions" value="resource:person:edit" {% if 'resource:person:edit' in current_role_permissions %}checked{% endif %}></td>
                                                <td class="text-center"><input type="checkbox" name="permissions" value="resource:person:delete" {% if 'resource:person:delete' in current_role_permissions %}checked{% endif %}></td>
                                            </tr>
                                            <tr>
                                                <td><strong>小区/建筑</strong></td>
                                                <td class="text-center"><input type="checkbox" name="permissions" value="resource:building:view" {% if 'resource:building:view' in current_role_permissions %}checked{% endif %}></td>
                                                <td class="text-center"><input type="checkbox" name="permissions" value="resource:building:add" {% if 'resource:building:add' in current_role_permissions %}checked{% endif %}></td>
                                                <td class="text-center"><input type="checkbox" name="permissions" value="resource:building:edit" {% if 'resource:building:edit' in current_role_permissions %}checked{% endif %}></td>
                                                <td class="text-center"><input type="checkbox" name="permissions" value="resource:building:delete" {% if 'resource:building:delete' in current_role_permissions %}checked{% endif %}></td>
                                            </tr>
                                            <tr>
                                                <td><strong>网格管理</strong></td>
                                                <td class="text-center"><input type="checkbox" name="permissions" value="resource:grid:view" {% if 'resource:grid:view' in current_role_permissions %}checked{% endif %}></td>
                                                <td class="text-center"><input type="checkbox" name="permissions" value="resource:grid:add" {% if 'resource:grid:add' in current_role_permissions %}checked{% endif %}></td>
                                                <td class="text-center"><input type="checkbox" name="permissions" value="resource:grid:edit" {% if 'resource:grid:edit' in current_role_permissions %}checked{% endif %}></td>
                                                <td class="text-center"><input type="checkbox" name="permissions" value="resource:grid:delete" {% if 'resource:grid:delete' in current_role_permissions %}checked{% endif %}></td>
                                            </tr>
                                            <tr>
                                                <td><strong>全局权限</strong></td>
                                                <td colspan="2" class="text-center">
                                                    <input type="checkbox" name="permissions" value="import_export:all" {% if 'import_export:all' in current_role_permissions %}checked{% endif %}>
                                                    <label>导入导出全部数据</label>
                                                </td>
                                                <td colspan="2" class="text-center">
                                                    <input type="checkbox" name="permissions" value="system:view" {% if 'system:view' in current_role_permissions %}checked{% endif %}>
                                                    <label>访问系统设置页面</label>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="text-center mt-4">
                                    <button type="submit" class="btn btn-primary btn-lg px-5 me-3">
                                        <i class="bi bi-save me-2"></i>保存权限
                                    </button>
                                    <button type="button" id="restoreDefaultBtn" class="btn btn-warning btn-lg px-5">
                                        <i class="bi bi-arrow-counterclockwise me-2"></i>恢复默认
                                    </button>
                                </div>
                            </form>
                            {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-info-circle fs-1 d-block mb-3"></i>
                                    请从上方选择一个角色开始编辑权限
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- 用户管理 - 按钮紧凑优化，强制单行 -->
                        <div class="tab-pane fade {% if tab == 'users' %}show active{% endif %}" id="users" role="tabpanel">
                            <div class="d-flex justify-content-end mb-3">
                                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                    <i class="bi bi-person-plus me-1"></i>添加新用户
                                </button>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover table-bordered align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="5%">#</th>
                                            <th width="19%">用户名</th>
                                            <th width="19%">显示姓名</th>
                                            <th width="19%">电话</th>
                                            <th width="16%">角色</th>
                                            <th width="22.5%" class="text-center">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if users %}
                                            {% for user in users %}
                                            <tr>
                                                <td>{{ loop.index }}</td>
                                                <td><strong>{{ user.username }}</strong></td>
                                                <td>{{ user.full_name or '未设置' }}</td>
                                                <td>{{ user.phone or '未设置' }}</td>
                                                <td>
                                                    {% if user.roles %}
                                                        {% for role in user.roles %}
                                                        <span class="badge bg-info me-1">
                                                            {{ role | replace('community_admin', '社区管理员') | replace('grid_user', '网格员') | replace('super_admin', '超级管理员') }}
                                                        </span>
                                                        {% endfor %}
                                                    {% else %}
                                                        <span class="text-muted">无角色</span>
                                                    {% endif %}
                                                </td>
                                                <td class="user-actions text-center">
                                                    <!-- 禁用/启用 -->
                                                    <form action="{{ url_for('system_settings.toggle_user', user_id=user.id) }}" method="POST" class="d-inline">
                                                        <button type="submit" class="btn btn-sm btn-{{ 'danger' if user.is_active else 'success' }}">
                                                            <i class="bi bi-{{ 'slash-circle' if user.is_active else 'check-circle' }}"></i>
                                                            {{ '禁用' if user.is_active else '启用' }}
                                                        </button>
                                                    </form>

                                                    <!-- 重置密码 -->
                                                    <form action="{{ url_for('system_settings.reset_password', user_id=user.id) }}" method="POST" class="d-inline"
                                                          onsubmit="return confirm('确定重置该用户密码为默认值？')">
                                                        <button type="submit" class="btn btn-sm btn-outline-secondary">
                                                            <i class="bi bi-key"></i>重置密码
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="6" class="text-center text-muted py-4">
                                                    <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                                                    暂无用户记录
                                                </td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加新用户模态框 -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <form method="POST" action="{{ url_for('system_settings.add_user') }}">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">添加新用户</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">用户名 <span class="text-danger">*</span></label>
                        <input type="text" name="username" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">显示姓名</label>
                        <input type="text" name="full_name" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">电话</label>
                        <input type="text" name="phone" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">分配角色 <span class="text-danger">*</span></label>
                        <select name="role_id" class="form-select" required>
                            <option value="">-- 请选择角色 --</option>
                            {% for role in roles %}
                            <option value="{{ role.id }}">{{ role.name | replace('community_admin', '社区管理员') | replace('grid_user', '网格员') | title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-success">添加用户</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 恢复默认权限按钮
    document.getElementById('restoreDefaultBtn')?.addEventListener('click', function() {
        if (confirm('确认恢复该角色的默认权限？此操作不可撤销。')) {
            const form = this.closest('form');
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'restore_default';
            input.value = 'true';
            form.appendChild(input);
            form.submit();
        }
    });
</script>
{% endblock %}
